# Архитектура бота

## Структура проекта

```
OPTIMIZATION/
├── bot.py                  # Точка входа, создание и запуск бота
├── config.py              # Конфигурация бота и сообщений
├── max_bot.py             # Старая версия (монолитная)
├── requirements.txt       # Зависимости
├── .env.example          # Пример файла с переменными окружения
├── .gitignore            # Игнорируемые файлы
│
├── handlers/             # Обработчики событий
│   ├── __init__.py
│   ├── commands.py       # Обработчики команд (/menu, /stats и т.д.)
│   ├── callbacks.py      # Обработчики callback кнопок
│   └── messages.py       # Обработчики текстовых сообщений
│
├── keyboards/            # Клавиатуры с кнопками
│   ├── __init__.py
│   └── main.py          # Основные клавиатуры (меню, кликер и т.д.)
│
├── database/            # Работа с данными
│   ├── __init__.py
│   └── user_data.py     # Модель данных пользователя и FSM операции
│
└── utils/               # Утилиты и вспомогательные функции
    ├── __init__.py
    ├── formatters.py    # Форматирование сообщений
    └── achievements.py  # Система достижений
```

## Модули

### bot.py
Главный файл приложения. Отвечает за:
- Создание экземпляра бота
- Регистрацию всех обработчиков
- Настройку логирования
- Запуск бота

### config.py
Централизованная конфигурация:
- `BotConfig` - настройки бота (токен, формат, логирование)
- `GameConfig` - настройки игровых механик
- `Messages` - все текстовые сообщения бота

### handlers/
Обработчики событий разделены по типам:

#### commands.py
- `/start` - приветствие и инициализация
- `/menu` - главное меню
- `/stats` - статистика пользователя
- `/clicker` - запуск кликера
- `/help` - справка

#### callbacks.py
- `clicker` - открыть кликер
- `click` - обработка клика
- `random` - генерация случайного числа
- `stats` - показать статистику
- `help` - показать справку
- `menu` - вернуться в меню

#### messages.py
- Эхо-режим для всех текстовых сообщений
- Подсчет отправленных сообщений

### keyboards/
Построение клавиатур с кнопками:
- `get_main_menu()` - главное меню
- `get_clicker_keyboard()` - клавиатура кликера
- `get_back_keyboard()` - кнопка возврата
- `get_custom_keyboard()` - создание кастомных клавиатур

### database/
Работа с данными пользователей через FSM:

#### UserData
Dataclass с полями:
- `clicks` - количество кликов
- `random_calls` - вызовов генератора
- `messages_sent` - отправленных сообщений
- `total_score` - общий счет
- `achievements` - список достижений

Методы:
- `add_click()` - добавить клик
- `add_random_call()` - добавить вызов
- `add_message()` - добавить сообщение
- `add_achievement()` - добавить достижение

Функции:
- `get_user_data()` - получить данные из FSM
- `update_user_data()` - сохранить данные в FSM
- `init_user_data()` - инициализировать новые данные

### utils/

#### formatters.py
- `format_stats()` - форматирование статистики
- `format_clicker()` - форматирование кликера
- `format_random_number()` - форматирование случайного числа
- `format_number_with_suffix()` - форматирование больших чисел (K, M, B)

#### achievements.py
- `check_clicker_achievements()` - проверка достижений
- `get_achievement_message()` - получить сообщение о достижении
- `get_all_achievements()` - список всех достижений

## Принципы архитектуры

### 1. Модульность
Каждый модуль отвечает за свою область:
- Обработчики не знают о форматировании
- Форматтеры не знают о данных
- Клавиатуры независимы от логики

### 2. Расширяемость
Легко добавить новые функции:
- Новую команду → добавить в `handlers/commands.py`
- Новую кнопку → добавить в `handlers/callbacks.py`
- Новую клавиатуру → добавить в `keyboards/main.py`
- Новое достижение → добавить в `utils/achievements.py`

### 3. Конфигурируемость
Все настройки в `config.py`:
- Тексты сообщений
- Пороги достижений
- Параметры игр

### 4. Типизация
Использование dataclass и type hints для:
- Безопасности типов
- Автодополнения в IDE
- Документации кода

### 5. Разделение ответственности
- **Handlers** - обработка событий
- **Database** - работа с данными
- **Utils** - вспомогательные функции
- **Keyboards** - построение UI
- **Config** - настройки

## Как добавить новую функцию

### Новая команда
1. Добавить обработчик в `handlers/commands.py`
2. Добавить текст в `config.Messages` (если нужно)
3. Зарегистрировать в `register_command_handlers()`

### Новая кнопка
1. Создать клавиатуру в `keyboards/main.py`
2. Добавить обработчик в `handlers/callbacks.py`
3. Зарегистрировать в `register_callback_handlers()`

### Новая игра/механика
1. Добавить данные в `database/UserData`
2. Создать обработчики в `handlers/`
3. Добавить форматтеры в `utils/formatters.py`
4. Настроить в `config.GameConfig`

### Новое достижение
1. Добавить в `utils/achievements.py`
2. Добавить проверку в соответствующий обработчик
3. Использовать `UserData.add_achievement()`

## Преимущества новой структуры

1. **Читаемость** - легко найти нужный код
2. **Поддерживаемость** - изменения локализованы
3. **Тестируемость** - каждый модуль можно тестировать отдельно
4. **Масштабируемость** - легко добавлять новые функции
5. **Переиспользование** - утилиты можно использовать везде
6. **Командная работа** - разные люди могут работать над разными модулями
